name: linux

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  BUILD_TYPE: Release

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v3
        with:
          lfs: true
          fetch-depth: 2

      - uses: actions/checkout@v3
        with:
          ref: gh-pages
          path: pages

      - name: Update commit information on gh-pages
        run: |
          python3 tests/SysY2022/perf/update_info.py pages
          cd pages
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add .
          git status
          git commit -m "Update commit information by ${{github.sha}}"
          git push

      - name: Env
        run: |
          sudo apt update
          sudo apt install spim ninja-build # llvm-15-dev gcc-11-riscv64-linux-gnu g++-11-riscv64-linux-gnu gcc-10-mipsel-linux-gnu g++-10-mipsel-linux-gnu

      - name: Format
        run: make format-check

      # - uses: actions/checkout@v3
      #   with:
      #     repository: dtcxzyw/qemu
      #     path: ${{github.workspace}}/qemu

      # - name: Build qemu
      #   run: |
      #     cd qemu
      #     ./configure --target-list=riscv64-linux-user,mipsel-linux-user,arm-linux-user --enable-plugins
      #     make -j
      #     echo "QEMU_PATH=$(pwd)/build" >> $GITHUB_ENV

      - name: Build
        run: |
          mkdir build && cd build
          cmake .. -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMMC_LLVM_SUPPORT=OFF
          cmake --build . -j

      - name: Test
        run: cd build && ctest --verbose

      - name: Generate Performance Source
        run: cd build && python3 ../tests/test_driver.py bin/cmmc ../tests arm,compile

      - name: Upload Performance Source
        uses: actions/upload-artifact@v2
        with:
          name: PerformanceSource
          path: build/bin/SysY2022/

  test:
    runs-on: self-hosted
    needs: build

    steps:
      - uses: actions/checkout@v3
        with:
          lfs: true

      - uses: actions/checkout@v3
        with:
          ref: gh-pages
          path: pages

      - name: Download Artifacts
        uses: actions/download-artifact@v2
        with:
          name: PerformanceSource
          path: ${{github.workspace}}/bin/SysY2022/

      - name: Run
        run: |
          cd bin
          python3 ../tests/test_driver.py cmmc ../tests arm,run

      - name: Push perf data to gh-pages
        if: always()
        run: |
          python3 tests/SysY2022/perf/collect.py bin/SysY2022/performance pages
          cd pages
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add .
          git commit -m "Push perf data by ${{github.sha}}"
          git push
